#!/bin/bash

yadm decrypt

# install all packages in "packages" file
filename="packages"
cd ~/.local/backup/

total_pkgs=$(grep '^[a-zA-Z0-9]' packages | wc -l)
curr_pkg=0
while read pkg_name
do
  # Omit lines that are blank or commented out
  if [[ -n $pkg_name ]] && ! [[ $pkg_name =~ ^#.* ]]; then

    pkg_name=$(echo $pkg_name | cut -d "#" -f 1)

    curr_pkg=$((curr_pkg+1))
    echo -ne "Installing package $curr_pkg/$total_pkgs\r"
    paru -Syu --noconfirm $pkg_name -y > /dev/null 2>&1

    if [[ $? -ne 0 ]]
    then
      echo $pkg_name >> ~/failed_installs.txt
    fi

  fi
done < $filename

cd

# Special case dotfiles to clean up home dir
# npm
sudo mkdir /usr/etc
echo "prefix=${XDG_DATA_HOME}/npm
cache=${XDG_CACHE_HOME}/npm
init-module=${XDG_CONFIG_HOME}/npm/config/npm-init.js" > npmrc
sudo mv npmrc /usr/etc/
# zsh
sudo mkdir /etc/zsh
echo "ZDOTDIR=$HOME/.config/shell" > zshenv
sudo mv zshenv /etc/zsh/

# pacman features - Add a PacMan visual and enable parallel downloads
sudo sed '/ParallelDownloads/s/^#/ILoveCandy\n/g' -i /etc/pacman.conf

# Change default shell to zsh
chsh -s $(which zsh)

# Install zsh plugins
mkdir -p $XDG_DATA_HOME/zsh/plugins
cd $XDG_DATA_HOME/zsh/plugins
git clone https://github.com/zdharma-continuum/fast-syntax-highlighting
git clone https://github.com/zsh-users/zsh-completions
git clone https://github.com/zsh-users/zsh-autosuggestions
git clone https://github.com/zsh-users/zsh-history-substring-search

# Get wallpapers
git clone https://github.com/cohenchris/wallpapers ~/.local/wallpapers

# Disables auto-creation of 'Documents' folder and deletes any unnecessary folders
sed -i 's/XDG_DOCUMENTS_DIR.*/XDG_DOCUMENTS_DIR="$HOME\/"/g' ~/.config/user-dirs.dirs
echo 'XDG_CONFIG_DIR="$HOME/.config"' >> ~/.config/user-dirs.dirs
cd
rm -rf Desktop Documents Music Pictures Public Templates Videos

# Change yadm and wallpapers git to use ssh
yadm remote set-url origin git@github.com:cohenchris/dotfiles.git
cd ~/.local/wallpapers
git remote set-url origin git@github.com:cohenchris/wallpapers.git

# Personal suckless terminal emulator
git clone https://github.com/cohenchris/st
cd st
sudo make clean install
cd ../
rm -rf st/

# Post-install script
echo "#!/bin/bash
# Brave extensions
# Bitwarden
brave https://chrome.google.com/webstore/detail/bitwarden-free-password-m/nngceckbapebfimnlniiiahkandclblb?hl=en
# uBlock Origin
brave https://chrome.google.com/webstore/detail/ublock-origin/cjpalhdlnbpafiamejdnhcphjbkeiagm?hl=en-GB
# Floccus
brave https://chrome.google.com/webstore/detail/floccus-bookmarks-sync/fnaicdffflnofjppbagibeoednhnbjhg
# Honey
brave https://chrome.google.com/webstore/detail/honey-automatic-coupons-r/bmnlcjabgnpnenekpadlanbbkooimhnj?hl=en-GB
# Recommended Settings
brave https://www.privacyguides.org/browsers/#brave

# TODO:
#   - install extensions
#   - import gpg private key
#   - import and/or upload ssh key to github
" > post-install.sh

chmod +x post-install.sh

sudo reboot
